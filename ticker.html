<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="robots" content="noindex, nofollow" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="data:,">
  <title>BBC News Ticker</title>

  <style>
    body{
      margin:0;
      overflow:hidden;
      background-color: rgba(0,0,0,0);
      color:#fff;
      font-family: Arial, sans-serif;
      font-size:20px;
    }
    #ticker-container{
      width:100%;
      white-space:nowrap;
      overflow:hidden;
      box-sizing:border-box;
      padding:10px 12px;
    }
    #ticker{
      display:inline-block;
      padding-left:100%;
      animation: scroll-left 220s linear infinite;
      will-change: transform;
    }
    @keyframes scroll-left{
      from{ transform: translateX(0%); }
      to{ transform: translateX(-100%); }
    }
    .item{ display:inline; }
    .title{ font-weight:700; }
    .desc{ font-weight:400; opacity:0.9; margin-left:10px; }
    .sep{ display:inline-block; margin:0 18px; opacity:0.9; font-weight:700; }
  </style>
</head>

<body>
  <div id="ticker-container">
    <div id="ticker">Loading headlines...</div>
  </div>

  <script>
    var rssFeed = "https://feeds.bbci.co.uk/news/rss.xml";
    var workerBase = "https://bbc-rss-proxy.hitrmiss2023.workers.dev";
    var proxyUrl = workerBase + "/rss?url=" + encodeURIComponent(rssFeed);

    var tickerEl = document.getElementById("ticker");
    var lastGoodHTML = tickerEl.innerHTML;
    var inFlight = false;

    function escapeHTML(str) {
      return String(str).replace(/[&<>"']/g, function (m) {
        return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" })[m];
      });
    }
    function stripTags(str){ return String(str).replace(/<[^>]*>/g, ""); }
    function restartAnimation(){
      tickerEl.style.animation = "none";
      tickerEl.offsetWidth; // reflow
      tickerEl.style.animation = "";
    }
    function fetchWithTimeout(url, ms){
      ms = ms || 12000;
      return Promise.race([
        fetch(url, { cache: "no-store" }),
        new Promise(function(_, reject){
          setTimeout(function(){ reject(new Error("Fetch timeout")); }, ms);
        })
      ]);
    }
    function getText(node, tag){
      var n = node.getElementsByTagName(tag);
      if (!n || !n[0] || !n[0].textContent) return "";
      return n[0].textContent.trim();
    }

    async function loadHeadlines(){
      if (inFlight) return;
      inFlight = true;

      try{
        var resp = await fetchWithTimeout(proxyUrl, 12000);
        if (!resp.ok) throw new Error("HTTP " + resp.status);

        var text = await resp.text();
        var xml = new DOMParser().parseFromString(text, "application/xml");
        if (xml.getElementsByTagName("parsererror").length) throw new Error("XML parse error");

        var items = xml.getElementsByTagName("item");
        var maxItems = Math.min(items.length, 20);

        var html = "";
        for (var i=0; i<maxItems; i++){
          var title = getText(items[i], "title");
          var desc  = stripTags(getText(items[i], "description"));

          if (desc.length > 140) desc = desc.slice(0, 137).replace(/\s+$/, "") + "…";
          if (!title && !desc) continue;

          if (html) html += '<span class="sep">• |</span>';

          html += '<span class="item">' +
                    '<span class="title">' + escapeHTML(title) + '</span>' +
                    (desc ? '<span class="desc">— ' + escapeHTML(desc) + '</span>' : '') +
                  '</span>';
        }

        if (!html) throw new Error("No items parsed");
        tickerEl.innerHTML = html;
        lastGoodHTML = html;
        restartAnimation();
      } catch(e){
        console.error("Ticker error:", e);
        tickerEl.innerHTML = lastGoodHTML;
      } finally {
        inFlight = false;
      }
    }

    loadHeadlines();
    setInterval(loadHeadlines, 10 * 60 * 1000);
  </script>
</body>
</html>
